#include <ArduinoMqttClient.h>
#include <WiFiNINA.h>
#include "arduino_secrets.h"

char WIFI_SSID[] = SECRET_SSID;
char WIFI_PASS[] = SECRET_PASS;

WiFiClient net;
MqttClient mq(net);

const char BROKER_HOST[] = "test.mosquitto.org";
constexpr int BROKER_PORT = 1883;

const char TOPIC_LIGHT[] = "LightIntensity";

void onMsg(int);

void setup() {
  Serial.begin(9600);
  while (!Serial) {}

  Serial.print("Wi-Fi → ");  Serial.println(WIFI_SSID);
  while (WiFi.begin(WIFI_SSID, WIFI_PASS) != WL_CONNECTED) { Serial.print('.'); delay(5000); }
  Serial.println("\nWi-Fi connected");

  Serial.print("MQTT → ");  Serial.println(BROKER_HOST);
  if (!mq.connect(BROKER_HOST, BROKER_PORT)) {
    Serial.print("Error "); Serial.println(mq.connectError());
    while (true);
  }
  Serial.println("MQTT connected\n");

  mq.onMessage(onMsg);
  mq.subscribe(TOPIC_LIGHT);
  Serial.print("Subscribed to "); Serial.println(TOPIC_LIGHT);
}

void loop() { mq.poll(); }

void onMsg(int len) {
  Serial.print("Topic "); Serial.print(mq.messageTopic());
  Serial.print(" ("); Serial.print(len); Serial.println(" bytes)");
  while (mq.available()) Serial.print((char)mq.read());
  Serial.println();
}
