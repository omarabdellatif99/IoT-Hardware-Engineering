#include <ArduinoMqttClient.h>
#include <WiFiNINA.h>
#include "arduino_secrets.h"

char networkSsid[] = SECRET_SSID;
char networkPass[] = SECRET_PASS;

WiFiClient net;
MqttClient broker(net);

const char HOST[] = "test.mosquitto.org";
constexpr int PORT = 1883;

const char TOPIC_A[] = "real_unique_topic";
const char TOPIC_B[] = "real_unique_topic_2";
const char TOPIC_C[] = "real_unique_topic_3";

void onMessage(int);

void setup() {
  Serial.begin(9600);
  while (!Serial) {}

  Serial.print("Wi-Fi → ");
  Serial.println(networkSsid);
  while (WiFi.begin(networkSsid, networkPass) != WL_CONNECTED) {
    Serial.print('.');
    delay(5000);
  }
  Serial.println("\nWi-Fi connected");

  Serial.print("MQTT → ");
  Serial.println(HOST);
  if (!broker.connect(HOST, PORT)) {
    Serial.print("Failed, error ");
    Serial.println(broker.connectError());
    while (true);
  }
  Serial.println("MQTT connected\n");

  broker.onMessage(onMessage);
  broker.subscribe(TOPIC_A);
  broker.subscribe(TOPIC_B);
  broker.subscribe(TOPIC_C);

  Serial.println("Subscribed:");
  Serial.println(TOPIC_A);
  Serial.println(TOPIC_B);
  Serial.println(TOPIC_C);
}

void loop() {
  broker.poll();
}

void onMessage(int len) {
  Serial.print("Topic: ");
  Serial.print(broker.messageTopic());
  Serial.print(" (");
  Serial.print(len);
  Serial.println(" bytes)");
  while (broker.available()) Serial.print((char)broker.read());
  Serial.println();
}


